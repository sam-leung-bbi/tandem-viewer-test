<header>
    <script src="https://tandem.autodesk.com/viewer/viewer3D.js"></script>
    <link href="https://tandem.autodesk.com/viewer/style.min.css" rel="stylesheet" type="text/css">
</header>
<h4> Tandem | Hello World Demo</h4>
<hr>
<button onclick="logout()">Logout</button>
<button onclick="logMeIn()" class="btn btn-lg btn-default" id="autodeskSigninButton">
    <img src="https://github.com/Autodesk-Forge/learn.forge.viewhubmodels/raw/master/img/autodesk_text.png"
      height="20"> Sign in
  </button>

  <div id="viewer" style="border:1px solid; height: 400px; width: 100%;"></div>


<script>
    async function logout() {
        delete(window.sessionStorage.token);
        fetch('/oauth/logout');
        window.location.hash = "-";
        window.location.reload();
    };

    async function showUserProfileImg() {
        const res = await (await fetch('https://developer.api.autodesk.com/userprofile/v1/users/@me', {headers:{"Authorization":`Bearer ${window.sessionStorage.token}`}})).json();
        const img = res.profileImages.sizeX120;
        document.getElementById("autodeskSigninButton").innerHTML=`<img src="${img}"/>`
    }

    async function logMeIn() {
        const hashParams = location.hash.slice(1).split('&').map(i=>{return i.split('=')})
        if (hashParams[0][0]=="access_token") 
            window.sessionStorage.token = hashParams[0][1];

        if (window.sessionStorage.token) {
            await showUserProfileImg();
            return;
        }

        const redirectURL = `https://developer.api.autodesk.com/authentication/v1/authorize?response_type=token&client_id=cw3yYG0wCvDOcPxxfH91UC1KHWuajJyR&redirect_uri=https%3A%2F%2Fwallabyway.github.io%2Ftandem-api-hello-world%2F&scope=data%3Aread`
        location.href = redirectURL;
    }

    //logMeIn();


</script>
